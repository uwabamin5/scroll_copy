# ページ構造診断スクリプト設計

## 目的

既存のデバッグモードブラウザに接続し、現在開いているページの構造を分析して、正しいセレクタを特定する。

## 機能要件

### 1. スクロール可能なコンテナの検出

以下の条件でコンテナ候補を検索：
- `overflow: auto` または `overflow: scroll` を持つ要素
- `id` 属性に "scroll" を含む要素
- `class` 属性に "scroll" を含む要素
- 高さが制限されている（`max-height` または固定 `height`）要素

### 2. テキスト行要素の検出

コンテナ内で以下を検索：
- 繰り返し出現する要素パターン
- `class` 属性に "entry", "text", "line", "message" を含む要素
- テキストコンテンツを持つ要素

### 3. 話者名要素の検出（オプション）

- `class` 属性に "speaker", "author", "name" を含む要素
- `id` 属性に "speaker", "timestamp" を含む要素

## 出力形式

```json
{
  "containerCandidates": [
    {
      "selector": "#scrollToTargetTargetedFocusZone",
      "found": false,
      "reason": "Element not found"
    },
    {
      "selector": "#newScrollContainer",
      "found": true,
      "elementCount": 1,
      "hasOverflow": true,
      "dimensions": {
        "width": 800,
        "height": 600,
        "scrollHeight": 5000
      }
    }
  ],
  "textElementCandidates": [
    {
      "selector": "[class^='entryText-']",
      "count": 87,
      "sampleText": "サンプルテキスト"
    },
    {
      "selector": ".message-text",
      "count": 87,
      "sampleText": "サンプルテキスト"
    }
  ],
  "speakerElementCandidates": [
    {
      "selector": "[id^='timestampSpeakerAriaLabel-']",
      "count": 87,
      "sampleText": "話者名"
    }
  ],
  "recommendations": {
    "container": "#newScrollContainer",
    "textElement": "[class^='entryText-']",
    "speakerElement": "[id^='timestampSpeakerAriaLabel-']",
    "confidence": "high"
  }
}
```

## 実装方針

1. **既存ブラウザに接続**
   - `--connect-existing` と同じ方法で接続
   - デフォルトポート: 9222

2. **JavaScript評価で構造分析**
   - `page.evaluate()` を使用してDOM構造を分析
   - 複数の候補を検出して優先順位付け

3. **結果の保存**
   - JSON形式で `page_structure.json` に保存
   - 人間が読みやすい形式でコンソールにも出力

## 使用方法

```powershell
# 既存のデバッグモードブラウザに接続して診断
python inspect_page.py --connect-existing

# 特定のURLを開いて診断
python inspect_page.py --url "https://example.com/page"

# 出力ファイルを指定
python inspect_page.py --connect-existing --output page_structure.json
```

## 次のステップ

1. このスクリプトを実装（Codeモードで）
2. 実行してページ構造を分析
3. 推奨されたセレクタを `doctor` コマンドで検証
4. 正しいセレクタを確認後、READMEを更新